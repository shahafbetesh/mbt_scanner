<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סורק נוכחות</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; background-color: #f4f4f9; color: #333; }
        #container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; }
        h1 { color: #4a4a4a; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { background-color: #007aff; color: white; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #aaa; }
        #reader { width: 100%; margin-top: 20px; border-radius: 8px; overflow: hidden; display: none; }
        #result { margin-top: 20px; font-weight: bold; min-height: 40px; color: #28a745; }
    </style>
</head>
<body>
    <div id="container">
        <h1>סורק נוכחות</h1>
        <input type="text" id="sessionName" placeholder="רשום את שם המפגש (למשל, מפגש-2)">
        <button id="startButton">התחל סריקה</button>
        <div id="reader"></div>
        <div id="result"></div>
    </div>

    <script>
    !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Html5Qrcode={})}(this,function(e){"use strict";var t,r={facingMode:"user",zoom:0},n={fps:10,qrbox:250,aspectRatio:1.7777778,disableFlip:!1,videoConstraints:r};function i(e){return e||(n.fps=10,n.qrbox=250,n.aspectRatio=1.7777778,n.disableFlip=!1,n.videoConstraints=r),{fps:e.fps||n.fps,disableFlip:!!e.disableFlip,qrbox:e.qrbox||n.qrbox,aspectRatio:e.aspectRatio||n.aspectRatio,videoConstraints:e.videoConstraints||n.videoConstraints}}var o,s,a;function c(e){var t;return(t=e,!!(t.id||t.deviceId))?e.id?e.id:e.deviceId:e}function u(e){return"string"==typeof e}function l(e){return"function"==typeof e}(t||(t={})).QR_CODE="qr_code",(o||(o={})).AZTEC="aztec",(o||(o={})).CODABAR="codabar",(o||(o={})).CODE_39="code_39",(o||(o={})).CODE_93="code_93",(o||(o={})).CODE_128="code_128",(o||(o={})).DATA_MATRIX="data_matrix",(o||(o={})).MAXICODE="maxicode",(o||(o={})).ITF="itf",(o||(o={})).EAN_13="ean_13",(o||(o={})).EAN_8="ean_8",(o||(o={})).PDF_417="pdf_417",(o||(o={})).RSS_14="rss_14",(o||(o={})).RSS_EXPANDED="rss_expanded",(o||(o={})).UPC_A="upc_a",(o||(o={})).UPC_E="upc_e",(o||(o={})).UPC_EAN_EXTENSION="upc_ean_extension",(s||(s={})).PORTRAIT="portrait",(s||(s={})).LANDSCAPE="landscape",(a||(a={})).ERROR="error",a.WARNING="warning",a.INFO="info";class d{constructor(e,t){this.format=e,this.type=t}static create(e){const r=e.split(",");if(1==r.length)return"qr_code"===r[0]?new d(t.QR_CODE,"code"):new d(o[r[0]],"code");{const e=[],t=[];for(const n of r)"qr_code"===n?e.push(n):t.push(o[n]);if(0!==e.length&&0!==t.length)throw"The decoder library doesn't support mixing QR code with other formats.";return 0!==t.length?new d(t,"code"):new d(e,"code")}}}class h{constructor(e,t){this.data=e,this.decodedText=t}static create(e,t){const r=[];for(const n of e)r.push(new h(n.rawValue,n.format));return r}}class p{constructor(e){this.message=e,this.name="UnsupportedOperationException"}toString(){return`${this.name}: ${this.message}`}}function m(e){return e.LuminanceSource?e:e.default?e.default:e}function f(e){return e.BinaryBitmap?e:e.default?e.default:e}function g(e){return e.Result?e:e.default?e.default:e}function _(e){return e.DecodeHintType?e:e.default?e.default:e}function v(e){return e.MultiFormatReader?e:e.default?e.default:e}class b{constructor(e,t){if(!t)throw"Use Html5Qrcode.getCameras() to get list of cameras.";this.format=d.create(e),this.verbose=t,this.decoder=null}scan(e,t,r,n){return this.scanAsync(e,t,r,n)}async scanAsync(e,t,r,n){if(!r||!l(r))throw"successCallback is required callback.";if(n&&!l(n))throw"errorCallback is required callback.";const o=this;return o.decoder||await this.initializeDecoder(),new Promise((s,a)=>{o.decoder.scan(e,t,e=>{const t=h.create(e,o.verbose);r(t.decodedText,t)},e=>{"string"==typeof e&&-1!==e.indexOf("NotFoundException")?n&&n("QR code not found."):n&&n(e)}).then(e=>{s(e)}).catch(e=>{a(e)})})}async initializeDecoder(){if(this.format.type,this.format.format,this.decoder)return;const e=this.verbose;if(!window.ZXing)throw"Use html5-qrcode.min.js without edit, ZXing not found.";const t=await window.ZXing,r=new Map;if(e&&console.log("ZXing library loaded"),this.format.format===d.QR_CODE.format){const n=new t.MultiFormatReader(e);r.set(_(t).TRY_HARDER,e),r.set(_(t).POSSIBLE_FORMATS,[g(t).QR_CODE]);n.setHints(r);const i=new Map;i.set("need_result_point_callbacks",!1),n.setNeedResultPointCallback(i);const s=this;this.decoder={scan:async(r,n,a,c)=>{const u=new Image;u.onload=()=>{try{const r=u.width,n=u.height;let c;if(o.isScanning){const t=document.createElement("canvas");t.width=r,t.height=n;const i=t.getContext("2d",{willReadFrequently:!0});i.drawImage(u,0,0,r,n),c=i.getImageData(0,0,r,n)}else c=void 0;if(!c)return void a("image load failed");const d=new(m(t).default)(c.data,r,n),h=new(f(t).default)(new(t.HybridBinarizer)(d)),p=n.decode(h,i);a(p.getText())}catch(e){c(e),e}};const o=s;u.onerror=c,u.onabort=c,u.src=r}};const s=this;return new Promise(t=>{s.decoder.scan().then(()=>{}).catch(()=>{}),t()})}}throw new p(`format ${this.format} not supported.`)}}{constructor(e){this.logger=e}log(e){this.logger.log(e)}warn(e){this.logger.warn(e)}error(e){this.logger.error(e)}}var y="https-qrcode";function w(e,t,r){const n=document.createElement("div");n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.style.background="rgba(255, 255, 255, 0.6)",n.style.width="100%",n.style.height="100%",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center";const i=document.createElement("div");i.style.width=`${e}px`,i.style.height=`${t}px`,i.style.background="white",i.style.border=`${r}px solid #32CD32`,i.style.borderRadius="10px";const o=document.createElement("div");o.style.width=`${e-2*r}px`,o.style.height=`${t-2*r}px`,o.style.border="4px dashed #32CD32",o.style.borderRadius="7px",i.appendChild(o),n.appendChild(i);const s=document.createElement("div");s.style.position="absolute",s.style.top="0px",s.style.left="0px",s.style.zIndex=1,s.appendChild(n);const a=document.createElement("div");return a.style.position="relative",a.style.width="100%",a.style.height="100%",a.appendChild(s),{container:a,banner:n,qrbox:i,closeButton:void 0}}function C(e,t,r){let n,i=1,o=1;const s=(e,t)=>{n=document.getElementById(e),i=n.offsetWidth,o=n.offsetHeight};if(s(e,!0),"number"==typeof t)n.style.width=`${t}px`;else{const e=t.width,r=t.height;if(e&&r)throw"The qrbox config cannot have both width and height defined.";if(e)n.style.width=`${e}px`;else{if(!r)throw"The qrbox config must have at least width or height defined.";n.style.width=`${r*i/o}px`}}if(r)n.style.height=`${n.offsetWidth/r}px`;else{const e=t.width,r=t.height;if(!e&&r)n.style.height=`${r}px`;else{if(!e)return;const t=n.offsetWidth;n.style.height=`${t*o/i}px`}}}class S{constructor(e,t,r){this.elementId=e,this.verbose=t,this.logger=new b(r?r:console),this.shouldScan=e,this.isScanning=!1,this._initExisitingIfAny()}static async getCameras(){if(navigator.mediaDevices)return new Promise((e,t)=>{navigator.mediaDevices.enumerateDevices().then(t=>{const r=[];for(const n of t)"videoinput"===n.kind&&r.push({id:n.deviceId,label:n.label});e(r)}).catch(e=>{t(e)})});t([])}_getScanRegion(e,t){const r=document.getElementById(this.elementId);if(!r)throw`HTML Element with id=${this.elementId} not found`;const n={x:0,y:0,width:e,height:t};return n.width=r.clientWidth?r.clientWidth:n.width,n.height=r.clientHeight?r.clientHeight:n.height,{x:n.x,y:n.y,width:n.width,height:n.height}}_getShadedRegionBounds(e,t){const r=document.getElementById(this.elementId);if(!r)throw`HTML Element with id=${this.elementId} not found`;const n=r.getBoundingClientRect();return{x:n.left,y:n.top,width:n.width,height:n.height}}_setupVideo(e){const t=document.createElement("video");return t.style.width="100%",t.style.height="100%",t.autoplay=!0,t.playsInline=!0,t.muted=!0,t.setAttribute("autoplay","true"),t.setAttribute("muted","true"),t.setAttribute("playsinline","true"),t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.zIndex="0",e&&!1===e.disableFlip&&(t.style.transform="scaleX(-1)"),t}_clearElement(){const e=document.getElementById(this.elementId);if(e){for(;e.lastChild;)e.removeChild(e.last-child);return!0}return!1}async start(e,t,r,n){if(!this.shouldScan)throw"Cannot start scanning, scanner has been stopped.";if(!e)throw"cameraIdOrConfig is required";if(!r||!l(r))throw"qrCodeSuccessCallback is required callback.";if(this.isScanning)throw"Scanning is already in progress, stop it first.";if(n&&!l(n))throw"qrCodeErrorCallback is required callback.";const o=i(t);this._clearElement();const s=document.getElementById(this.elementId);if(!s)throw`HTML Element with id=${this.elementId} not found`;this.currentScanConfig=o,this.qrCodeSuccessCallback=r,this.qrCodeErrorCallback=n;const a=this.currentScanConfig.videoConstraints;"object"!=typeof a&&(a={});const d=u(e);let h,p,m;if(d){const t=Object.assign({},a);t.deviceId={exact:c(e)},m=t}else{const t=e,r=Object.assign({},a);t.aspectRatio&&(r.aspectRatio=t.aspectRatio),t.facingMode&&(r.facingMode=t.facingMode),t.deviceId&&(r.deviceId=t.deviceId),m=r}return new Promise((e,t)=>{this.localMediaStream?e():(this.shouldScan||t("Scanner stopped forcefully."),navigator.mediaDevices.getUserMedia({video:m}).then(r=>{this.localMediaStream=r,h=this._setupVideo(o),p=s.attachShadow({mode:"open"}),s.style.position="relative",s.style.overflow="hidden",p.appendChild(h),e()}).catch(e=>{t(`Error getting user media: ${e}`)}))}).then(()=>{this.isScanning=!0,this.videoElement=h,this.videoElement.srcObject=this.localMediaStream;const e=this.videoElement.style;e.width="100%",e.height="100%",e.objectFit="cover",this.videoElement.play(),this._possiblySetupQrbox(o),this._scan(o)})}_possiblySetupQrbox(e){if(e.qrbox){const t=u(e.qrbox)?parseInt(e.qrbox,10):e.qrbox;if("number"!=typeof t&&("object"!=typeof t||!t.width&&!t.height))throw`Invalid instance of QrDimensions passed for qrbox, expected 'number' or instance of QrDimensions with width or height defined.`;if(e.aspectRatio&&("number"!=typeof t||t>Math.min(this.videoElement.videoWidth,this.videoElement.videoHeight)))throw`Invalid qrbox size passed, staisfying aspect ratio not possible.`;const r=w(300,300,5);this.shadedRegionElement=r.container,this.domElement.shadowRoot.appendChild(this.shadedRegionElement);const n=this.domElement.shadowRoot.getElementById(y);C(y,t,e.aspectRatio),this.qrboxRegion=n.getBoundingClientRect()}}stop(){if(!this.shouldScan)return this.logger.log("Scan is not in progress."),Promise.resolve();if(this.localMediaStream){const e=this.localMediaStream.getVideoTracks();for(const t of e)t.stop()}return this.shouldScan=!1,this.isScanning=!1,this.videoElement&&this.videoElement.srcObject?this.videoElement.srcObject=null:this.logger.log("No video element found to remove srcObject from."),this._clearElement(),Promise.resolve()}async scan(){if(this.isScanning){if(!this.videoElement)return;if(this.videoElement.paused||this.videoElement.ended)return;const e=this.videoElement.videoWidth/this.videoElement.videoHeight,t=this.currentScanConfig;let r;if(t.aspectRatio)r=t.aspectRatio;else{const n=this.videoElement.getBoundingClientRect();r=n.width/n.height}const n=Math.floor(this.videoElement.videoWidth),i=Math.floor(this.videoElement.videoHeight),o=this._getScanRegion(n,i),s=this._createCanvasElement(o.width,o.height);s.getContext("2d",{willReadFrequently:!0}).drawImage(this.videoElement,0,0,o.width,o.height);try{if(!window.ZXing)return void this.logger.log("ZXing not found, delaying scanning");const a=await window.ZXing;if(!a.BrowserQRCodeReader)return void this.logger.log("BrowserQRCodeReader not found, delaying scanning.");const c=new a.BrowserQRCodeReader,u=c.decode(s);this.qrCodeSuccessCallback(u.text,u)}catch(e){if(this.qrCodeErrorCallback)this.qrCodeErrorCallback(e);else{const t="NotFoundException: No MultiFormat Readers were able to detect the code.";e.message.indexOf(t)!==-1||console.log(e.message)}}}setTimeout(()=>{this.scan()},this._getTimeoutFps(this.currentScanConfig.fps))}async _scan(e){const t=this;let r;try{await this._waitForVideoToPlay()}catch(e){return void t.logger.error(`createScanner failed on _waitForVideoToPlay; Error: ${e}`)}const n=()=>{r||(r=new Promise((r,n)=>{let i=0,o=0,s=null;const a=document.createElement("canvas");a.width=t.videoElement.videoWidth,a.height=t.videoElement.videoHeight;const c=a.getContext("2d",{willReadFrequently:!0}),u=()=>{if(!t.shouldScan)return;if(!t.isScanning){if(i>5)return void n(`Scanner activity stopped for ${i} frames.`);return i++,void setTimeout(u,0)}i=0;try{if(0===t.videoElement.readyState)return t.logger.warn("Video element not ready yet, delaying scan."),void setTimeout(u,t._getTimeoutFps(e.fps));const a=t.videoElement.currentTime;if(a===s)return void setTimeout(u,0);s=a,c.drawImage(t.videoElement,0,0,t.videoElement.videoWidth,t.videoElement.videoHeight);const d=()=>{try{const e=c.getImageData(0,0,t.videoElement.videoWidth,t.videoElement.videoHeight);if(t.qrCodeSuccessCallback)t.qrCodeSuccessCallback(null,e);else{t.logger.warn("qrCodeSuccessCallback not defined."),n("qrCodeSuccessCallback not defined.")}r()}catch(e){t.logger.error(e),n(e)}};d()}catch(e){if(!t.qrCodeErrorCallback)throw e;o>10&&n(`Unable to scan QR code for ${o} frames.`);o++,t.qrCodeErrorCallback(e)}setTimeout(u,t._getTimeoutFps(e.fps))};u()}))};n()}_getTimeoutFps(e){return 1e3/e}_createCanvasElement(e,t,r){if(!e||!t)throw"width and height required";const n=document.createElement("canvas");return n.style.width=r?r:"100%",n.style.height=r?r:"100%",n.width=e,n.height=t,n}_waitForVideoToPlay(){return new Promise((e,t)=>{let r=0;const n=()=>{this.videoElement.paused||this.videoElement.ended||(this.videoElement.currentTime>0?e():r++>10?t("Video play timed out."):setTimeout(n,50))};n()})}_initExisitingIfAny(){const e=document.getElementById(this.elementId);if(e)for(;e.lastChild;)e.removeChild(e.last-child)}}e.Html5Qrcode=S,e.Html5QrcodeScanner=class{constructor(e,t,r){this.elementId=e,this.config=t,this.verbose=this.config?this.config.verbose:!1,this.logger=new b(this.verbose,r),this.qrcode=null,this._isScanning=!1}render(e,t){const r=n=>{if("string"==typeof n)this.logger.log(n);else if(n.decodedText)this.logger.log(n.decodedText)},o=n=>{r(n),e(n.decodedText,n)},s=n=>{r(n),t(n)};this.lastScanDamperedDate=new Date,this.lastScanDamperedResult=void 0;const a=n=>{const t=new Date;if(!(this.lastScanDamperedDate.getSeconds()===t.getSeconds()))if(this.lastScanDamperedResult)if(this.lastScanDamperedResult.decodedText===n.decodedText);else o(n),this.lastScanDamperedDate=new Date,this.lastScanDamperedResult=n;else o(n),this.lastScanDamperedDate=new Date,this.lastScanDamperedResult=n};this._validateConfig(),this._displayScanningMarkup();const c=i(this.config);this.qrcode=new S(this.elementId,this.verbose,this.logger),this.qrcode.start({facingMode:"environment"},c,a,s).then(()=>{this._isScanning=!0,this._showHideScanRegion(),this._setupRenderedElements()}).catch(e=>{this.qrcode=null,this.logger.error(e)})}clear(){const e=()=>{this.qrcode.stop().then(()=>{this._isScanning=!1,this._showHideScanRegion(),this._setupRenderedElements(),this._clearRenderedElements(),this.qrcode=null}).catch(e=>{this.logger.error("Failed to clear html5-qrcode scanner. ",e)})},t=document.getElementById(this.elementId);if(t)for(;t.lastChild;)t.removeChild(t.last-child);e()}_validateConfig(){if(this.config)if("number"!=typeof this.config.fps||this.config.fps<=0)throw"fps should be a positive number.";if(this.config.qrbox){if("number"==typeof this.config.qrbox)if(this.config.qrbox<=0)throw"qrbox should be a positive number.";else{if("object"!=typeof this.config.qrbox)throw"qrbox should be a number or object.";if(!this.config.qrbox.width&&!this.config.qrbox.height)throw"qrbox should have at least width or height."}if(this.config.aspectRatio&&("number"!=typeof this.config.aspectRatio||this.config.aspectRatio<=0))throw"aspectRatio should be a positive number."}}_displayScanningMarkup(){const e=document.getElementById(this.elementId);if(!e)throw`HTML Element with id=${this.elementId} not found`;e.innerHTML='<div id="qr-code-full-region"></div><div id="qr-code-header-message"></div>';const t=e.getElementsByTagName("div")[0],r=e.getElementsByTagName("div")[1],n=this.config?this.config.qrbox:250;t.style.border=`1px solid silver`;const i=this.config?this.config.aspectRatio:1.7777778;if(t.style.width=`${n}px`,t.style.height=`${n/i}px`,this.verbose){r.style.display="block"}else r.style.display="none"}_setupRenderedElements(){const e=`${this.elementId}-button-camera-permission`,t=`${this.elementId}-button-camera-stop`,r=`${this.elementId}-button-camera-start`,n=`${this.elementId}-select-camera`,i=document.getElementById(`${this.elementId}-header-message`);if(!i)throw"header message element not found.";i.innerHTML='<button id="'+e+'">Request Camera Permissions</button>';const o=this;document.getElementById(e).addEventListener("click",function(){document.getElementById(e).style.display="none",i.innerHTML='<button id="'+t+'"">Stop Scanning</button> | <button id="'+r+'"">Start Scanning</button> | <select id="'+n+'"></select>',S.getCameras().then(e=>{const t=document.getElementById(n);for(const r of e)t.innerHTML+="<option value='"+r.id+"'>"+r.label+"</option>"}).catch(e=>{o.logger.error("Error getting cameras",e)})})}_clearRenderedElements(){const e=document.getElementById(this.elementId);if(!e)return;const t=e.getElementsByTagName("div")[1];t.innerHTML=""}_showHideScanRegion(){const e=`${this.elementId}-code-full-region`;document.getElementById(e).style.display=this._isScanning?"block":"none"}},e.Html5QrcodeSupportedFormats=[o.AZTEC,o.CODABAR,o.CODE_39,o.CODE_93,o.CODE_128,o.DATA_MATRIX,o.MAXICODE,o.ITF,o.EAN_13,o.EAN_8,o.PDF_417,o.RSS_14,o.RSS_EXPANDED,o.UPC_A,o.UPC_E,o.UPC_EAN_EXTENSION],Object.defineProperty(e,"__esModule",{value:!0})});
    </script>
    
    <script>
        const startButton = document.getElementById('startButton');
        const sessionNameInput = document.getElementById('sessionName');
        const resultDiv = document.getElementById('result');
        const readerDiv = document.getElementById('reader');

        function onScanSuccess(decodedText, decodedResult) {
            const sessionName = sessionNameInput.value.trim();
            const finalUrl = decodedText + "&session=" + encodeURIComponent(sessionName);

            resultDiv.textContent = 'מעבד...';
            fetch(finalUrl)
                .then(response => response.text())
                .then(text => {
                    resultDiv.textContent = text;
                    if (navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                    setTimeout(() => {
                        if(resultDiv.textContent === text) {
                            resultDiv.textContent = 'מוכן לסריקה הבאה...';
                        }
                    }, 2500);
                })
                .catch(err => {
                    resultDiv.textContent = 'שגיאת רשת.';
                    console.error(err);
                });
        }

        function onScanFailure(error) {
          // This function is called when a scan attempt fails, but the camera is still running.
          // We can ignore it to keep the scanner active.
        }

        startButton.addEventListener('click', () => {
            const sessionName = sessionNameInput.value.trim();
            if (!sessionName) {
                alert('יש להזין שם מפגש לפני שמתחילים לסרוק.');
                return;
            }

            sessionNameInput.disabled = true;
            startButton.disabled = true;
            startButton.textContent = "טוען מצלמה...";
            readerDiv.style.display = 'block';

            const html5QrCode = new Html5Qrcode("reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 } 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch((err) => {
                    console.log(`Unable to start scanning, error: ${err}`);
                    resultDiv.textContent = 'לא ניתן להפעיל את המצלמה.';
                });
        });
    </script>
</body>
</html>
