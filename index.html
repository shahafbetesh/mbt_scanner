<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סורק נוכחות</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; background-color: #f4f4f9; color: #333; }
        #container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; }
        h1 { color: #4a4a4a; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { background-color: #007aff; color: white; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #aaa; }
        #reader { width: 100%; margin-top: 20px; border-radius: 8px; overflow: hidden; display: none; }
        #result { margin-top: 20px; font-weight: bold; min-height: 40px; color: #28a745; }
    </style>
</head>
<body>
    <div id="container">
        <h1>סורק נוכחות</h1>
        <input type="text" id="sessionName" placeholder="רשום את שם המפגש (למשל, מפגש-2)">
        <button id="startButton">התחל סריקה</button>
        <div id="reader"></div>
        <div id="result"></div>
    </div>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script>
        const startButton = document.getElementById('startButton');
        const sessionNameInput = document.getElementById('sessionName');
        const resultDiv = document.getElementById('result');
        const readerDiv = document.getElementById('reader');
        let html5QrCode;

        startButton.addEventListener('click', () => {
            const sessionName = sessionNameInput.value.trim();
            if (!sessionName) {
                alert('יש להזין שם מפגש לפני שמתחילים לסרוק.');
                return;
            }

            sessionNameInput.disabled = true;
            startButton.disabled = true;
            startButton.textContent = "טוען מצלמה...";
            readerDiv.style.display = 'block';

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => {
                    // decodedText is the URL from the student's QR code
                    const finalUrl = decodedText + "&session=" + encodeURIComponent(sessionName);

                    resultDiv.textContent = 'מעבד...';
                    fetch(finalUrl)
                        .then(response => response.text())
                        .then(text => {
                            resultDiv.textContent = text;
                            // Vibrate for feedback
                            if (navigator.vibrate) {
                                navigator.vibrate(100);
                            }
                            setTimeout(() => {
                                if(resultDiv.textContent === text) {
                                    resultDiv.textContent = 'מוכן לסריקה הבאה...';
                                }
                            }, 2500);
                        })
                        .catch(err => {
                            resultDiv.textContent = 'שגיאת רשת.';
                            console.error(err);
                        });
                },
                (errorMessage) => {
                    // handle scan error
                })
            .catch((err) => {
                console.log(`Unable to start scanning, error: ${err}`);
                resultDiv.textContent = 'לא ניתן להפעיל את המצלמה.';
            });
        });
    </script>
</body>
</html>
